# Overlay file that runs the PowerSync service alongside the Supabase stack.
# Usage:
#   export POWERSYNC_CONFIG_B64=$(base64 -w0 path/to/powersync/config.yaml)
#   docker compose -f docker/docker-compose.yml -f docker/docker-compose.powersync.yml up powersync
# Or use the helper script: ./docker/run-powersync.sh
name: supabase

services:
  powersync:
    container_name: supabase-powersync
    image: journeyapps/powersync-service:latest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Base64 encoded PowerSync config file content.
      POWERSYNC_CONFIG_B64: ${POWERSYNC_CONFIG_B64:?Set POWERSYNC_CONFIG_B64 to the base64 encoded PowerSync config}
      # Connection strings used inside config.yaml.
      PS_REPLICATION_URI: ${PS_REPLICATION_URI:?Set PS_REPLICATION_URI to the replication Postgres connection URI}
      PS_STORAGE_URI: ${PS_STORAGE_URI:?Set PS_STORAGE_URI to the storage Postgres connection URI}
      PS_SUPABASE_JWT_SECRET: ${PS_SUPABASE_JWT_SECRET:?Set PS_SUPABASE_JWT_SECRET so PowerSync can validate Supabase JWTs}
    ports:
      - "${POWERSYNC_PORT:-8080}:80"
